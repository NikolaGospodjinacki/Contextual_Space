# Contextual Space - AI Assistant Context

This file provides context for AI coding assistants (GitHub Copilot, Claude, ChatGPT, etc.) working on this project.

## Project Overview

**Contextual Space** is a real-time collaborative canvas web application where multiple users can:
- Place text notes anywhere on a shared 2D canvas
- See each other's cursors in real-time
- Edit and delete their own notes
- Create "reserved areas" that hide content from other users
- Search/filter notes by username or content

## Architecture Summary

```
Frontend (React)  ←──WebSocket──→  Backend (Node.js)  ←──→  DynamoDB
    │                                   │
    └── CloudFront/S3                   └── App Runner (Container)
```

### Key Design Decisions

1. **WebSocket for real-time**: Socket.IO handles all real-time communication
2. **Hybrid store**: In-memory cache + DynamoDB persistence
3. **Client-side filtering**: Hidden areas are filtered client-side for performance
4. **OIDC authentication**: GitHub Actions uses OIDC (no AWS access keys stored)
5. **Min 1 instance**: App Runner keeps 1 instance warm to avoid cold starts

## Code Locations

### Backend (`backend/src/`)

| File | Purpose |
|------|---------|
| `index.ts` | Express server setup, CORS, health endpoint |
| `socket/handlers.ts` | **All WebSocket event handlers** - this is the main logic |
| `store/index.ts` | Hybrid in-memory + DynamoDB data store |
| `store/dynamodb.ts` | DynamoDB CRUD operations |
| `types/index.ts` | TypeScript interfaces for all data types |
| `utils/colors.ts` | User color generation |

### Frontend (`frontend/src/`)

| File | Purpose |
|------|---------|
| `App.tsx` | Root component with username modal |
| `components/Canvas.tsx` | **Main canvas component** - most UI logic here |
| `components/TextBox.tsx` | Individual draggable text note |
| `components/OtherCursor.tsx` | Other users' cursor display |
| `hooks/useSocket.ts` | Socket.IO connection hook with all state |
| `services/socket.ts` | Socket.IO client wrapper |
| `types/index.ts` | TypeScript interfaces |

### Infrastructure (`infrastructure/terraform/`)

| File | Purpose |
|------|---------|
| `apprunner.tf` | App Runner service + auto-scaling config |
| `dynamodb.tf` | DynamoDB table definition |
| `ecr.tf` | ECR repository for Docker images |
| `s3_cloudfront.tf` | S3 bucket + CloudFront distribution |
| `github_oidc.tf` | OIDC provider for GitHub Actions |
| `iam.tf` | IAM roles for App Runner |

## Data Types

```typescript
// TextBox - a note on the canvas
interface TextBox {
  id: string;
  userId: string;
  username: string;
  content: string;
  positionX: number;
  positionY: number;
  color: string;
  createdAt: string;
  updatedAt: string;
}

// ReservedArea - a region that can be hidden
interface ReservedArea {
  id: string;
  username: string;
  userId: string;
  x: number;
  y: number;
  width: number;
  height: number;
  isHidden: boolean;
  color: string;
}

// CursorPosition - real-time cursor
interface CursorPosition {
  userId: string;
  username: string;
  x: number;
  y: number;
  color: string;
}
```

## WebSocket Events

| Event | Direction | Description |
|-------|-----------|-------------|
| `user:join` | C→S | Join with username |
| `sync:initial` | S→C | Send all data on connect |
| `textbox:create` | C→S | Create new note |
| `textbox:created` | S→All | Broadcast new note |
| `textbox:update` | C→S | Update note position/content |
| `textbox:updated` | S→All | Broadcast update |
| `textbox:delete` | C→S | Delete note |
| `textbox:deleted` | S→All | Broadcast deletion |
| `cursor:move` | C→S | Cursor position update |
| `cursor:moved` | S→Others | Broadcast cursor |
| `reservation:*` | Both | Reserved area CRUD |

## Common Tasks

### Add a new feature

1. Add types to `backend/src/types/index.ts` and `frontend/src/types/index.ts`
2. Add event handlers in `backend/src/socket/handlers.ts`
3. Add store methods in `backend/src/store/index.ts`
4. Add UI in `frontend/src/components/Canvas.tsx`
5. Add socket listeners in `frontend/src/hooks/useSocket.ts`

### Deploy changes

Just push to `main`:
- `backend/**` changes → triggers `deploy-backend.yml`
- `frontend/**` changes → triggers `deploy-frontend.yml`

### Run locally

```bash
# Terminal 1
cd backend && npm run dev

# Terminal 2
cd frontend && npm run dev
```

### Modify infrastructure

```bash
cd infrastructure/terraform
terraform plan -var-file=terraform.tfvars
terraform apply -var-file=terraform.tfvars
```

## Environment Variables

### Backend
| Variable | Description |
|----------|-------------|
| `PORT` | Server port (default: 3001) |
| `USE_DYNAMODB` | Enable DynamoDB (default: false) |
| `DYNAMODB_TABLE_NAME` | Table name |
| `FRONTEND_URL` | For CORS |

### Frontend
| Variable | Description |
|----------|-------------|
| `VITE_BACKEND_URL` | Backend URL for Socket.IO |

## AWS Resources

| Resource | Identifier |
|----------|------------|
| ECR | `871981698300.dkr.ecr.us-east-1.amazonaws.com/contextual-space-backend` |
| App Runner | `contextual-space-backend-dev` |
| DynamoDB | `contextual-space-textboxes-dev` |
| S3 | `contextual-space-frontend-dev-871981698300` |
| CloudFront | `E2V9NWK252L441` / `d3q2b06rnr38b0.cloudfront.net` |

## Important Notes

1. **Hidden area logic is client-side**: The `isTextBoxHidden()` function in `Canvas.tsx` filters textboxes. Server broadcasts everything; each client filters based on whose reservations they can see.

2. **No authentication**: Users just pick a username. There are no accounts.

3. **Cursor throttling**: Cursor movements are debounced to reduce WebSocket traffic.

4. **Mobile touch**: TextBox has `touch-action: none` to prevent canvas scrolling while dragging.

5. **App Runner auto-deploys**: Pushing to ECR triggers automatic deployment. The workflow just waits for it to finish.

## Testing

```bash
# Backend
cd backend && npm test

# Frontend  
cd frontend && npm test
```

## Cost

~$7-15/month:
- App Runner: $5-10 (1 min instance)
- DynamoDB: $0-1 (on-demand)
- S3 + CloudFront: $0-2

---

*This file is for AI assistants. Humans should read README.md and docs/* 
